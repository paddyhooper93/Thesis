MaskingPipeline_Notes.txt

% Step 1: BETMask
% Mask entire imaging volume
fractional_threshold = 0.3;  % (Values lower than 0.5 make mask larger)
gradient_threshold = 0.2; % (Values higher than 0.0 shift mask towards SI direction)

%% Step 2: Refining BET Mask
% min_open = 6 mm; min_close = 6 mm (set to > 5 mm, i.e., avoids large holes from high R2*).
Modification to refine_brain_mask_using_r2s.m:
For binary images, "imfill.m" only works in 2D.
% Run imfill slice-by-slice:
for i=size(mask_r2s_morph,3):-1:1
    mask_r2s_morph(:,:,i) = imfill(mask_r2s_morph(:,:,i),'holes');
end
% Avoid multiplying mask_r2s_morph by BETMask after this, since holes have been filled in.

%% Step 3: Erosion of 4 mm after RESHARP
% Matches overlay of local field generated by RESHARP

%% Step 4: Automatic cerebrospinal fluid mask "CSFMask"
% At both 3 T and 7 T, a mask of the gel medium was determined by 
% thresholding the final-echo magnitude image at 40%.
% (i.e. signal decay at T2* relaxation time: 1/e = 37%).
% (1) The final echo-magnitude was chosen since the vial edge loses around 40%
% its signal at around 20 to 30 ms due to a combined PD- and T2*-weighting.
% (2) Next, we eroded the mask of the gel medium by 7 mm. This operation
% excluded high-frequency information in the vicinity of the vial edge interface
% contaminating the CSFMask. The MEDI+0 algorithm assumes a 
% homogeneous susceptibility (i.e. low variance), and this step reduced 
% that variance substantially.